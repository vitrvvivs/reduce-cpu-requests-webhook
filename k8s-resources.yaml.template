---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reduce-cpu-requests-webhook
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: reduce-cpu-requests-webhook
  template:
    metadata:
      labels:
        app: reduce-cpu-requests-webhook
    spec:
      containers:
        - image: reduce-cpu-requests-webhook:latest
          imagePullPolicy: Never
          name: reduce-cpu-requests-webhook
          volumeMounts:
            - name: tls
              mountPath: "/etc/webhook/certs"
      volumes:
        - name: tls
          secret:
            secretName: reduce-cpu-requests-webhook-tls
      resources:
        requests:
          cpu: 10m
          memory: 50M
---
apiVersion: v1
kind: Service
metadata:
  name: reduce-cpu-requests-webhook
  namespace: kube-system
spec:
  ports:
    - port: 443
      protocol: TCP
      targetPort: 443
  selector:
    app: reduce-cpu-requests-webhook
---
apiVersion: v1
kind: Secret
metadata:
  name: reduce-cpu-requests-webhook-tls
  namespace: kube-system
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURiakNDQWxhZ0F3SUJBZ0lVSThDejVJTFRkRGZWSGdHS0JpVEE4QkV2aThBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd016RUxNQWtHQTFVRUJoTUNRVlV4SkRBaUJnTlZCQU1NRzNKbFpIVmpaUzFqY0hVdGNtVnhkV1Z6ZEhNdApkMlZpYUc5dmF6QWVGdzB5TlRBNE1UUXdNRE0yTVRoYUZ3MHlOakE0TVRRd01ETTJNVGhhTURNeEN6QUpCZ05WCkJBWVRBa0ZWTVNRd0lnWURWUVFEREJ0eVpXUjFZMlV0WTNCMUxYSmxjWFZsYzNSekxYZGxZbWh2YjJzd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEd28wanhYUHFoY2tmZ1hjMFEwUXlMTE9peApRZDlROG95cTVOSGpUQ3IxT0E2NDdpejZWbnRMZjJvM3dmK0VOeG9qbW5DU1prT1VHd3F0VC9xWHFSZlppVmt2CmU0L0xHUmV6TUJXclREbTU4VitKRHhPS2h1cGptVWJJTXE5SFBTTVZ1VE5XOUxkSGdlT1FuS1pwNU9NeWdOcnAKNDdIWmhPTVJqQ3RacjFWY09BWlhBV0t3Z0grQTk5cUg0UDlCZUVSQjRYRzIzVi90VHFIL1lpRy81RjdQbkprRApUaEpxdE93ZWlNZkFrdUN2ZDFtVjB2MG1RWTUzNlNibytSbU8zTXExMmF4RXhFQ1VEenNoMXl4b2x0QjVmRnp4ClRlZGJLdWRXaE8zYUFTMWZ2QzM5UDdNWXVlNGY4MDFseTgwOXl1TS9RL0tEWFlDY1B2VE5kakQrL2laUkFnTUIKQUFHamVqQjRNRFlHQTFVZEVRUXZNQzJDSzNKbFpIVmpaUzFqY0hVdGNtVnhkV1Z6ZEhNdGQyVmlhRzl2YXk1cgpkV0psTFhONWMzUmxiUzV6ZG1Nd0hRWURWUjBPQkJZRUZQMlV1QWdxVUIybERJTlJrUjZSMFBRTmNVR1FNQjhHCkExVWRJd1FZTUJhQUZDNFkrb2tOLzhCT1hoNGkzUURyYkkrU1BmYm5NQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUIKQVFBdHlDSjVqSDZVTWVyYmRiSmEwK2FoWWZZWVBkS3FQaDNLdytEQm5OWi80WkZBQUh4bDNzK1dmOEk1clRhMQpGWHlZdTg0aHNDejFmdjFXNjc1bXRKZGk3SWtpL1ZlQXRFL1cxaXlQWDYwdU1PZFhGZ3BmYWlKQVNQNUNKM205Cm5iNldXc0FuN3U5NnZWMDhaUnludENCclRpNk4xU0pjV05UT3JNN1dZblJsMzEyaTU3NS9YR1BOblZ0SFY5Q3EKaGZRQk1nanFhdXJqWm1abmhIREJQdFBySmJ1cWtLT1prdDcvQmtERnlGQWttS3ZwRWcwampDQW9uclNUVnovVQpFM2hIQlpRZTdnR1ZKUWxqSEoyV25MNXpEVzlxMjVPSmIzYkk4SUVlRXBjMkl3ZzNiWW1Ub0ZERi9hK1dPUmpLCnBEQ0ZFTDg5QVR2dHJKT1RtUmgvWWw0aQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRHdvMGp4WFBxaGNrZmcKWGMwUTBReUxMT2l4UWQ5UThveXE1TkhqVENyMU9BNjQ3aXo2Vm50TGYybzN3ZitFTnhvam1uQ1Naa09VR3dxdApUL3FYcVJmWmlWa3ZlNC9MR1Jlek1CV3JURG01OFYrSkR4T0todXBqbVViSU1xOUhQU01WdVROVzlMZEhnZU9RCm5LWnA1T015Z05ycDQ3SFpoT01SakN0WnIxVmNPQVpYQVdLd2dIK0E5OXFINFA5QmVFUkI0WEcyM1YvdFRxSC8KWWlHLzVGN1BuSmtEVGhKcXRPd2VpTWZBa3VDdmQxbVYwdjBtUVk1MzZTYm8rUm1PM01xMTJheEV4RUNVRHpzaAoxeXhvbHRCNWZGenhUZWRiS3VkV2hPM2FBUzFmdkMzOVA3TVl1ZTRmODAxbHk4MDl5dU0vUS9LRFhZQ2NQdlROCmRqRCsvaVpSQWdNQkFBRUNnZ0VBRG5ka2d0VWFBS051Q0lJZkdqNFZETmRnOEVvVFhxcU1OQmhnT1ZQS2g5WXMKUldnVkptSVZWTEUyM1o0QktrM0ZPYU4yMWNoRjB3VXFwOGRsZTJGWUhKVHVHb1dKUEJhWXR3WWlvVnNLWStBcgp4QUcyNVNhdDk5bWV1Sm1hY2JRT1ZFZWZXMkNJRmFtTWVKVEFTT0N3bTJoRmNOYm1TZHM4S3VHRU9DYXJJU2xqCnR2MWtDZFkzbTAxR0FNSDB2aGMzQ0E0bWdkWVhiTVNyYXB4Zk90cXJBNzhid1g3VlRacTRTL1VwRlJ6ODZ6Sy8KYnhZaW5WaW1UTW5oVFFUaGUzWjVWRjR5bHQ2bTlKWnpGYlpOazRBbWhNZm5SdUNXdjZZYnF4YzVPMTdaTzMvMQp0aTNRcFpHdWovNENGamo5eWViNHdNY25WTzRGVGhmNUtEMVl3Mm56ZVFLQmdRRCtxaDB3UkVxNTVEMHZQMkhhCkl0emp6WjFsc05IV1RqRDZ6V0ZRN3VQaFZRNkczRC9SaElSb3BiWS9CVDJhRG5OZlNteU0rZTI0U2ZkMkxFTFcKL0F6UlFjUkJHdnRyN2hBUW9wMDdNWVpuV0x2MFJpM0dOYWt6Mkd1R3ZFSEZiRzJGekc4ZEZmck1IUzFnaXBpOQp2YUc1ZTdJUE9FZWVnb0t2bFkwWCt1K3RhUUtCZ1FEeDVsY1UvM0prQmkySlFmeEVCV1FBSmplTkY3QWRXdXFxCnVmajJ2NE41dFIrYUxyL25tK2xhc2hnUWpreTRwSS9ydDlFL0xIOURtSm1KRzZHT2lJUTFlRDJMWXlTcGhWUG8KcEFiVDFZTGh6M0pMaGtCNHVEbWxVSkxuaTJ4UGVPRHlSWFdiQjVMN0ZCZk1mOFd1QUgwelRKNndjNllORzQraApvREttc0UzTXFRS0JnSGVqNmVTVUlOc21QQXhuWll3NmxyVzdFbmdFMHdBd2FkaGFCcDhrTEJEZmlkeVh1cSt1CjV4bld5RURoTUdpZzQxamdPUkVlRmExZnFvOXRDZFhBUWpGSkNXOWd3citZN3hreG5GYUQxTlhXblM2TWpkS3gKd1JVblZwVE0rc1ZLUkVYNG5qYjI3WVZaSzhsUU02UG9aQU1rOXFrcDBwUElVcWMweGoxKzJYMEpBb0dCQUxRRwozeXhMYUZDMG9GTVVmckFJNndHSmI3SmJ2TUE4RjRWejNxdVVvRDZGNDcwVnFkQ3ZJaDVUaU1GWmhoT3N0VWVTCmgvSGlKZHlpeHpGWkZRVkU2RS82NnFLLzZGc1pWUGRBaTZ3L3JLWnRndnhlTDhFb0tnNjBSb0I0TE9XQWFya2oKcElENlJCTUVReW40dFovbjBVWEtjaGVVR2pLTEhud0ZBMjAyck0veEFvR0JBT1RKNldMdjVxMkx1N0tEL0xXSgpCOXVrZWI1K1FMWUl2c3hPd05tL2R5aHJKU2Zjd1ZZaXlVRkdrS3c5TzdQZ25aQU80c1NYZmV1WTFOTU9ZTjljCjRmRmJaTm4yMHYwVmUwNFUyNDhzViswL1E2dG8wWG81aHpkMUJOcUd2bFY5SVM3NmRKUmR3dE9tVDdKR2liQW4KS2RBdEN0WVBwWnQ3NGVTNFFSS0diMGptCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: "reduce-cpu-requests-webhook.kind.io"
webhooks:
  - name: "reduce-cpu-requests-webhook.kind.io"
    matchConditions:
      # I think this resource deploys before the deployment,
      # so the deployment fails without this line, 
      # because it's waiting for a response from itself,
      # and it can't respond because it doesn't exist yet
      - name: skip-this
        expression: 'request.namespace != "kube-system"'
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
        scope: "*"
    clientConfig:
      service:
        namespace: kube-system
        name: reduce-cpu-requests-webhook
        path: /webhook
        port: 443
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURSekNDQWkrZ0F3SUJBZ0lVWWdiMnI4N0l3Q2hwbHMyMEtaWjMzVVJMeGhRd0RRWUpLb1pJaHZjTkFRRUwKQlFBd016RUxNQWtHQTFVRUJoTUNRVlV4SkRBaUJnTlZCQU1NRzNKbFpIVmpaUzFqY0hVdGNtVnhkV1Z6ZEhNdApkMlZpYUc5dmF6QWVGdzB5TlRBNE1UUXdNRE0yTVRoYUZ3MHlOakE0TVRRd01ETTJNVGhhTURNeEN6QUpCZ05WCkJBWVRBa0ZWTVNRd0lnWURWUVFEREJ0eVpXUjFZMlV0WTNCMUxYSmxjWFZsYzNSekxYZGxZbWh2YjJzd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDKzJveHNOU0g5MkZhamtFMXBGcU5ZZ2hkWApSRTN4RXZqaXpBVG9iSk95azhEZVY5RGxJVEdVZkFSS0tja2FvYThaNlNxanlYRy95c1FCQlJpTXUwSldhMTRLCnMvRnFVZkNWU0FXU2xnSi9GQmxjWno4ZnJWWWZHQzNxa1dUTkZGYkZXSEFwK08rNFZvZWlCNVgvRWxCU3RKWjAKdmxhS00rZ1BqUjk3Um82RnRsaWxFcmdRdi9ic2gzMFZtc2hjdXdjVjJldWNQWEZ3WkxhcnFjV1FnK2RXOHpsZgp4YXFxRE9WeDhMbE9Odzg1VmZwM3Z6WDlqbEQzS01RRTRWb1dEY0Joc1c4MUVkbHllNnFlWVZsYzF2amUxK0M2Cjg4ZlFKaldxQjA1QXkrd090d0xMb1BiN2U4dEJzUVRocnVIWEtCRjdNN2t4ajY5bE5xQ0RpVXJDVms3VEFnTUIKQUFHalV6QlJNQjBHQTFVZERnUVdCQlF1R1BxSkRmL0FUbDRlSXQwQTYyeVBrajMyNXpBZkJnTlZIU01FR0RBVwpnQlF1R1BxSkRmL0FUbDRlSXQwQTYyeVBrajMyNXpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzCkRRRUJDd1VBQTRJQkFRQ054Q2tBU3djMmhJMEZkbzdqbXBlSGdQTEI3YXdFL2dma1BTNUpyWG9wVVQrdjN1bmoKeXdUSmJsYWplRE4rSjZpdjJvRTZ5MjlsaEJERVdEd3UzbWN6azAwZGpzcDVkb0x0SlF2WmpQVEFEZitNcm5ycwo3bVBMVExUNHhWRjdHUnlMNGY0NFlQTUoramg1eURVM3o2N3Y5ZkJwRTlLcS9jQ1V3UzFpQ1VQUHYvVjhUYXVDClp2RjBLZ1JEQ1BMSDJ2NlAzanNHZFFaN0JWa2I2QVNoRVdTcWMzSEpTM2VORVloekM3YjBGSWprcUp4UC9aNGEKSTZycVBFT0lLYVFxSFFqUmNsM201ci9YTEVpa2E4RW5yNGF0cWhsYi92UnFkRTRISTMwblBZUHpucGtxeXpmYQpheW5SUkJRVzY0VEUvTlN6OGdRYmcvWHZZR0tTS3ZlRVorbXIKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    admissionReviewVersions: ["v1"]
    sideEffects: None
    timeoutSeconds: 2
